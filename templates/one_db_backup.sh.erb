#!/bin/bash

DB_USER='<%= oned_db_user %>'
DB_PASSWORD='<%= oned_db_password %>>'
DB_HOST='<%= oned_db_host %>'
DB_BACKUP='<%= oned_db %>'

BACKUP_DIR='<%= backup_dir %>'
BACKUP_FILE=$(hostname)-$(date +%F).sql
BACKUP_OPTS='<%= backup_opts %>'

# check if backup dir exits, if not create it or die.
[ ! -d $BACKUP_DIR ] && mkdir -p $BACKUP_DIR || :

mysqldump -h $DB_HOST -u $DB_USER -p "$DB_PASSWORD" $BACKUP_OPTS -r $BACKUP_DIR/$BACKUP_FILE -B $DB_BACKUP
bzip2 -9 $BACKUP_DIR/$BACKUP_FILE
find $BACKUP_DIR -mtime +15 -exec rm {} +